#!/bin/bash
#

echo "This is a SAMPLE run script for SMP LINPACK. Change it to reflect"
echo "the correct number of CPUs/threads, problem input files, etc.."

export MKL_MIC_ENABLE=1
export MIC_LD_LIBRARY_PATH=$MKLROOT/lib/mic:$MIC_LD_LIBRARY_PATH

# Check for presence of libraries required for AO
error=""
for f in libcoi_device.so.0 libiomp5.so libmkl_ao_worker.so; do
        found=""
        for d in $(echo $MIC_LD_LIBRARY_PATH | sed 's/:/ /g'); do
                test -f "$d/$f" && found=1
        done
        if test -z "$found"; then
                error=1
                echo " ** Error: required library $f not found in MIC_LD_LIBRARY_PATH"
        fi
done
test -n "$error" && echo "AO required libs not present. Forcing exit..." && exit -1

#    Setting up affinity for better threading performance
export KMP_AFFINITY=nowarnings,compact,1,0,granularity=fine

# Limit the number of CPU threads so that Intel(r) MIC coprocessor will get most of work
# export OMP_NUM_THREADS=1

# Force LINPACK to stop if MIC can't be used
# export MKL_MIC_DISABLE_HOST_FALLBACK=1

date
date > lin_xeon64_ao.txt
./xlinpack_xeon64 lininput_xeon64_ao | tee -a lin_xeon64_ao.txt
date >> lin_xeon64_ao.txt
echo -n "Done: "
date

arch=xeon64
{
  date
  ./xlinpack_$arch lininput_$arch
  echo -n "Done: "
  date
} | tee lin_$arch_ao.txt

